~~今後の目標~~というよりネタ帳
- - - -
[ＨＩＤａｓｐ](ＨＩＤａｓｐ.md) の再現はうまくいった。
- では、次は何を作りたい？
    - とりあえずシリアルポートを作りたい。
    - 実現方法としては
        - ＣＤＣクラス（ＡＶＲ-ＣＤＣ）。ただし２５６バイト程度縮める必要がある。難しい。

<!-- dummy comment line for breaking list -->

        - igorさんのような独自ドライバー（は自分では作れないのでたぶんigorさんの再現テストだけで終わると思う）方式
        - ＡＶＲ＿Ｍｏｎｉｔに埋め込む実装。---適当なコマンドでシリアルモードに突入する方式-普通のターミナルソフトが使えないのでＡＶＲ＿Ｍｏｎｉｔそのものを拡張して端末の代わりにする。--済

<!-- dummy comment line for breaking list -->


- ComEmulDrv経由のシリアル接続がうまくいきそうなので、やってみたい。--済
    - これがうまくいけばＨ８ｗｒｉｔｅ.ｃを動かしてＨ８／３０４８Ｆのファーム書き換えが出来るかも。

<!-- dummy comment line for breaking list -->

- 旧型ＡＤＢバス接続のAppleキーボードをＡＴ互換機（ＰＳ２バスかＵＳＢ）に繋ぎたい。

<!-- dummy comment line for breaking list -->

- ＰＣ８８０１のジャンクキーボードをＡＴ互換機に繋ぎたい。

<!-- dummy comment line for breaking list -->

    - なんでそんな欲求があるのかと言えば、実は１０１（１０４でも良い）英語キーが地方のＰＣショップではもう入手できなくなってるから。

<!-- dummy comment line for breaking list -->

- 壊れたＰＣＩカードから取り外した水晶を使ってＡＶＲ　ＵＳＢを動かしたい。
    - 豊富（？）にあるのが、２５ＭＨｚ（壊れた１００ＢＡＳＥのＮＩＣから外したもの）
    - ＡＴｔｉｎｙ２３１３では少しオーバークロックになる。
    - これで動かせるとめっぽう速い。（**だから何なんだ？**）
    - ２５だと三倍オーバートーン発振なんだろうなぁ・・・・発振するかなぁ・・・不安だ。

<!-- dummy comment line for breaking list -->


- トラ技付録だったＦＰＧＡ評価基板にAVRコアみたいなのを突っ込んで９６ＭＨｚ駆動させると

<!-- dummy comment line for breaking list -->
**LowSpeedでない**ＳＯＦＴ　ＵＳＢが出来るかも（無理かも）
    - そんなことするよりも素直にＵＳＢのＩＰを書き込んじゃったほうが良い？

<!-- dummy comment line for breaking list -->

- - - -
ＰｏｗｅｒＳｗｉｔｃｈ
- [ＡＶＲＵＳＢ](http://www.obdev.at/products/avrusb/index.html) のページにある、もっとも基本のアプリだ。
- ８つのスイッチ（ＬＥＤ）をＵＳＢから個別にＯｎ/Ｏｆｆ出来る。（専用のコマンドラインツールにて）
- サイズは他と比べて小さいので、ｔｉｎｙ２３１３に焼いても空きエリアが２５６バイトくらいある。
- **一応動作確認までＯＫ。**
- ただし、コントロール転送でＳｗの値を転送している。
- １０００回送るのに３秒くらい掛かるような気がする。
- １回のパケットはＬｏｗＳｐｅｅｄでは最大８バイトなので８Ｋバイト送り込むのに３秒掛かっているわけだ。
- 逆算で、２ｋ弱／秒くらいしか転送出来ない？？？ＵＳＢってそんなに遅いのか

<!-- dummy comment line for breaking list -->

- - - -
ＨＩＤｋｅｙｓ
- [ＨＩＤｋｅｙｓ](http://www.obdev.at/products/avrusb/hidkeys.html) 

<!-- dummy comment line for breaking list -->
を試してみた。
- これはＵＳＢキーボードと等価な動作をするデバイスだ。
- キーボード、マウス、ＧａｍｅＰａｄといった人用対話型入力インターフェース（ＨＩＤ）クラスはマイクロソフトが定義したクラスなので専用デバイスドライバーがなくてもＷｉｎｄｏｗｓの標準デイバスドライバーが対応する。
- つまり、デバイスドライバーの組み込みが不要なのだ。

<!-- dummy comment line for breaking list -->
~
- ａｔｍｅｇａだったので、ｔｉｎｙ２３１３に書き換え。
- タイマー０のプリスケーラーレジスタ名がすこし変わっていた。変更。
- PortCは無いので削除。
- USB接続ポートを変更。
- 実際にスイッチは繋がなかったが、ちゃんと動いたようだ。
- 改造crt.Sを使うと、

		./checksize main.bin
		ROM: 1828 bytes (data=4)
		RAM: 61 bytes
- なので、サイズ的には200バイトくらい余裕。
- INPUTエンドポイント１は使っているみたい。

<!-- dummy comment line for breaking list -->

~
- これの応用で、ＣＴＲＬとＡＬＴとＤＥＬだけが付いたＳｗとか。
- ＵＳＢメモリーに見せかけて、ＵＳＢに繋がれた瞬間にリセットとかＰｏｗｅｒＯｆｆを送り込む極悪ＵＳＢｋｅｙ。
- 一定時間ごとに無駄キーとかマウスムーブを送ってＰＣをスクリーンセーバーモードにしないキー。（これって、何に使うんだっけ？）
- 普通にＵＳＢＪｏｙＰａｄは作れるよな。うん。

<!-- dummy comment line for breaking list -->



- - - -
[ＵＳＢ−ＳＦＲ](http://www.recursion.jp/usbsfr/index.html) 
- ＣＤＣクラスで仮想ＣＯＭポートをつくって、実際にはＲＳ２３２にせずにＡＶＲ内部の対話シェル（？）でＡＶＲ制御が出来るといった感じ？（で良い？）
- 当然ｔｉｎｙ２３１３には入らないコードサイズ。
- だが、ＳＲＡＭサイズは足りている。

<!-- dummy comment line for breaking list -->

だいぶ改造に慣れたのでｔｉｎｙ２３１３に入れるテスト
- 対話シェルのコマンドインタープリタをばっさり削る。
- 当然crt.Sで圧縮。
- これでも、コードは足りたがデータを含めると２０４８を越える。
- しかたなく、watchDogを削る。

<!-- dummy comment line for breaking list -->

- 肝心の対話シェルは使えないが、ＣＤＣクラスとしてＷｉｎｄｏｗｓに認識させることは出来た。
- ＣＯＭ３という仮想ポートが出来ていて、teratermから接続できた。
- ＵＳＢスニファ [SnoopyPro](http://sourceforge.net/projects/usbsnoop/)  を使って、teratermとＡＶＲ間の交信が行われていることを確認した。

<!-- dummy comment line for breaking list -->
~
- 単なる仮想ＣＯＭポートのエコーバックサーバーならぎりぎり入る（？）かも
    - やってみた。うそくさいがエコーバック出来た。速度は秒間８ｋＢで頭打ち。

<!-- dummy comment line for breaking list -->

- 仮想ＣＯＭまで作らずに、ＨＩＤａｓｐのようにベンダーユニークのコントロール転送でコマンドを送り、ＡＶＲライターとしてではなく自分のＩＯポートの制御をさせることくらいならすぐにでも出来そうだ。
- 欠点は制御が１０ｍＳ単位になること。（なんで？）
- １０ｍＳ毎にコマンドも含め８バイト送受することまでならＨＩＤクラスで十分だ。

<!-- dummy comment line for breaking list -->

- - - -
もうひとつ別のアイディア
- ｔｉｎｙ２３１３をペアにした基板を用意して、ＡＴｍｅｇａ用の[ＢｏｏｔＬｏａｄｅｒ](http://www.obdev.at/products/avrusb/bootloadhid.html) もどきをやる。
- つまり、ａｓｐ不要の（というか自己書き換えな）ＵＳＢデバイスに近い。

<!-- dummy comment line for breaking list -->

- 片方はＨＩＤａｓｐ兼低速ＵＳＢ　Ｉ/Ｆであり、もう片方はａｓｐに常に繋がれて何時でも焼けるターゲットみたいな感じ。焼かないときは自律して動作してＵＳＢでＰＣと交信可能だ。

<!-- dummy comment line for breaking list -->

- ＣｈａＮさんのシリアルポートのＩＳＰなら、ＡＶＲが自律動作中はそのままシリアルコンソールになりうるので、（シリアルが使えるパソコンとＩＳＰがあるのならば、）わざわざ作るかという話もある。

<!-- dummy comment line for breaking list -->

- ＡＴｍｅｇａの手持ちがあるのなら、わざわざｔｉｎｙ２３１３を２個実装することもなかろう。

<!-- dummy comment line for breaking list -->
（**無いけど**）

- - - -
igorさん（スロバキアの人）のＵＳＢ to ＲＳ２３２というやつを拝見した。
- tiny2313で57600bpsを実現している。これは約８ＫＢ／秒だ。
- ＵＳＢの１フレームは１ｍＳであり、ＬｏｗＳｐｅｅｄの最大パケットは８バイトなので、単純に考えると８ｋＢ／秒。
- だが、ポーリング周期を１０ｍＳにしているとこの１／１０になるので８００バイト／秒（６４００ボー？？？暴れるぞコラ！ＵＳＢテメー１.５Ｍｂｐｓなんじゃなかったのか！¥バキッ）
- igorさんのは、Windowsカーネルドライバーで仮想シリアルを実現している。だから速い？libusbではだめなのか？（不明）
- ＵＳＢ２.０ ＰＤＦを見ると、１フレームに８バイトのインタラプト転送は最大６個、有意バイト数で４８バイトと書いてあるように見える（Table 5-6）のだが、目が悪いのか俺。
- その後ろに、１２Ｍｂｐｓのフルスピードではインタラプト転送の周期は1〜255mSだが、ＬｏｗＳｐｅｅｄ

<!-- dummy comment line for breaking list -->
の場合10〜255mSになると書かれている。詐欺だー。
- で、igorさんはどうやって高速化したのだろう。Windowsのドライバーは難しくてさっぱり訳が分からん。

<!-- dummy comment line for breaking list -->

- - - -
インタラプト転送のテストプログラム
- 速度計測

<!-- dummy comment line for breaking list -->

- - - -
独自ＵＳＢシリアルとＷｉｎｄｏｗｓ側クライアントの作成。
- ＣＤＣが容量的に無理くさいので、独自で試す。
- Ｗｉｎｄｏｗｓ版シリアルドライバーは作成可能か？

<!-- dummy comment line for breaking list -->

- - - -
### バルク転送のテストプログラム
- ~~かなり無理そう~~・・・。

<!-- dummy comment line for breaking list -->
~
- 実はUSB-Sfrのスケルトンを改造してＣＤＣではないベンダユニークなデバイスを作って速度計測をしてみた。

<!-- dummy comment line for breaking list -->
|１回の送信バイト数|コントロールWrite速度|バルクWrite速度|バイト数／フレーム|
|８バイト|８ｋバイト／秒|８ｋバイト／秒|８|
|１６バイト|１６ｋバイト／秒|１６ｋバイト／秒|１６|
|３２バイト|３２ｋバイト／秒|３２ｋバイト／秒|３２|
|６４バイト|３２ｋバイト／秒|３２ｋバイト／秒|３２|
|１２８バイト|４２.６ｋバイト／秒|４２.６ｋバイト／秒|４２|
|２５６バイト|４２.６ｋバイト／秒|４２.６ｋバイト／秒|４２|
|５１２バイト|４６.５ｋバイト／秒|４６.５ｋバイト／秒|４６|
|１０２４バイト|４６.６ｋバイト／秒|４６.６ｋバイト／秒|４６|
なんだ。速いじゃん。**ＬｏｗＳｐｅｅｄ**でも
- インタラプト転送はENDPOINT3がそれに相当するのだが、正しくハンドシェイクできていないようで、うまく動作してくれない。
    - ＣＤＣクラスでは、ＲＳ２３２のステータス転送に使っているような気がする。
- ＬｏｗＳｐｅｅｄの物理的な速度は１.５Ｍｂｐｓ（約１８０ｋＢ／秒）だが、わずか８バイトのペイロードに対して、ＳＹＮＣ、ヘッダー、ビットスタッフ、ＣＲＣ等オーバヘッドのほうがむしろ大きいのでまあ５０ｋＢも出るなら**御の字**なのかもしれない。

<!-- dummy comment line for breaking list -->

- ８バイト以上のパケットを送って計測したが、まだ本当に正しく転送されているかは調べていない。**データがこけてたら悲すい**・・・。

<!-- dummy comment line for breaking list -->

~
エンドポイント・デスクリプタをbulkからinterruptに変えて、同様のテスト
を行ってみた。
- interrupt転送ではインターバルが10mS固定になっている。
- ＣＤＣのENDPOINT3インターバルが2mSだったので、真似をしてみたが10mSより短くはならない。
- それどころか、パケット長を増やすと応答時間が反比例して遅くなる。どうせ最大ペイロードは８バイトなので、ほんとに１０ｍＳに８バイトのパケットしか送らないようになっているようだ。
- つまり、転送速度は１ｋＢ／秒に固定されている。（８００バイトでないのが不思議だが・・・なんらかの帯域制限に掛かったような感じ）

<!-- dummy comment line for breaking list -->

これらの計測が正しいとしたら
- ＬｏｗＳｐｅｅｄで帯域を稼ぎたいならコントロール転送かバルク転送が有利。
- インタラプト転送はクソ。
- 但し、ＬｏｗＳｐｅｅｄでのバルク転送はＵＳＢ１.１規格違反なので現在のＷｉｎｄｏｗｓＸＰ以外で動く保障は無い。
    - Ｌｉｎｕｘではカーネルパッチが必要らしい。
- コントロールWriteとバルクWriteはほぼ同じ速度が出る。
    - しかも１回の転送長を３２バイトくらいにすればそこそこ速度は出る。
    - 問題はＡＶＲのＲＡＭが少ないこと、か。

<!-- dummy comment line for breaking list -->


- - - -
ＡＶＲ−ＣＤＣ
- ｔｉｎｙ２３１３でＵＳＢシリアルに挑戦。
- ＡＴＭＥＧＡ８では可能（というか公開されている）
- ｔｉｎｙでやるにはコードサイズを２５６バイト以上縮める必要がある。

<!-- dummy comment line for breaking list -->

そのまえに、基本的なインタラプト転送が出来るようにしたい。

- - - -
バルク転送のテストプログラムその２
- 同じベンチマークをインテル８６５／Pen4のマザーでやってみたら、遅いことに気づいた。

<!-- dummy comment line for breaking list -->
|１回の送信バイト数|コントロールWrite速度|バルクWrite速度|バルクバイト数／フレーム|
|８バイト|２ｋバイト／秒|４ｋバイト／秒|４|
|１６バイト|３.２ｋバイト／秒|８ｋバイト／秒|８|
|３２バイト|４.５ｋバイト／秒|１５.８ｋバイト／秒|１６|
|６４バイト|５.８ｋバイト／秒|２１.３ｋバイト／秒|２１|
|１２８バイト|６.７ｋバイト／秒|２５.２ｋバイト／秒|２５|
|２５６バイト|７.３ｋバイト／秒|２８ｋバイト／秒|２８|
|５１２バイト|７.６ｋバイト／秒|２９.８ｋバイト／秒|３０|
|１０２４バイト|７.８ｋバイト／秒|３０.８ｋバイト／秒|３１|
だめじゃんＵＨＣＩ。
- ちなみに前のテストで使ったマザーはＳｉＳ７４６Ｆ／Ｂａｒｔｏｎ１.８ＧＨｚ
- どちらのテストも、マザボのバックパネルのＵＳＢコネクタを使用。ハブなし。ＯＳはＷｉｎＸＰで、ＯＳ環境はほぼ同じ。
- これを見た感じでは、ＵＳＢは遅くて使い物にならない。**秒間２ｋ〜４ｋＢでどうせいと**
- なぜＯＨＣＩと比べて４倍以上も違うのか？特にコントロール転送遅いぞ！。
- そもそもＵＳＢ２.０なんだからＥＨＣＩじゃなかったのかと小一時間。

<!-- dummy comment line for breaking list -->

いろいろマザーを変えて試すしかないのか俺。
- がびーん、Ｐ４Ｍ８９０Ｔ（ＶＩＡ）も遅かった。ｉ８６５と大体同じ傾向。

<!-- dummy comment line for breaking list -->

- もれなくインタラプト転送は常に１ｋ/Ｓだが。
- このままでは、ここは~~規格~~**企画倒れ**やー。

<!-- dummy comment line for breaking list -->

ＶＩＡ ＫＭ４００Ａで試してみた。
- 上と大体同じだ。
- 駄目押しで、ｉ８１５（河童セレ）でも試してみた。まあインテルは皆一緒か。
- 結論：速いのはＳｉＳだけだった。

<!-- dummy comment line for breaking list -->

SIZE(28){ＬｏｗＳｐｅｅｄ終了}


- - - -
もうＬｏｗＳｐｅｅｄには飽きた。
- コントロール転送を１ｍｓに１回処理できないようなら見切りをつけるしかない。
- ＳｉＳ以外の大多数のＵＨＣＩでは４ｍｓに１回らしい。
- 規格外のＢｕｌｋで速度を稼ぐという手もあるが、それでも最大３０ｋＢ／秒くらい。
- Ｂｕｌｋ受信がまだうまくいっていない。
- Ｂｕｌｋ送信のバリデーションもまだだ。

<!-- dummy comment line for breaking list -->
~
~
~
~
~
と書いたが、まだやっている。
- ターゲットをBulkに絞って、転送ルーチンを整理。
- Win32側のベンチマークと連動させ、bulk-read とbulk-writeの速度計測。
- おなじく、転送データのバリデーションもぼちぼち。

<!-- dummy comment line for breaking list -->

- ＡＶＲ側のサイズはコード＝1684bytes ＳＲＡＭ＝66byteまで縮めた。
- 代償にinterrupt転送とcontrolのベンダーユニーク処理を全部カット。
    - 問題は・・・bulk-read / write は非同期なのでハンドシェークには使えないってことが発覚。
    - ＲＳ２３２ＣのTx/Rxと同じやね。

<!-- dummy comment line for breaking list -->

- - - -
ＵＳＢ以外に目を向けよう。
- 周波数カウンタ。（これは割りと簡単らしい）
- ＲＣ計（デジタルテスターもどき）
- 時計。温度計。
- 赤外線リモコン。トランシーバー。
- ＬＥＤゲーム。
- 電子オルゴール。電子ピアノ。
- ＵＳＢ-ＭＩＤＩアダプタ。
- ＭＩＤＩオルゴール。
- ＳＤカードとの接続。

<!-- dummy comment line for breaking list -->

- 液晶ドライバー。（Ｈ８のキットに付いてきた奴がまだ残っている）
- データロガー。１秒間に１００サンプル以下とかならＵＳＢでも行けるか。
- 簡易オシロ、簡易ロジアナ。これもＵＳＢだと無理くさいが・・・。
- ＵＳＢ-ＣＤＣは、結局ｔｉｎｙ２３１３にやらせないほうがよいのか、それともigorさんのやつを試すべきか？

<!-- dummy comment line for breaking list -->



- - - -
目次

