[Ｈ８／３６９４Ｆ](Ｈ８／３６９４Ｆ.md) 


- トラ技２００４−４付録 ![http://journal.mycom.co.jp/news/2004/04/16/014b.jpg](http://journal.mycom.co.jp/news/2004/04/16/014b.jpg) 

<!-- dummy comment line for breaking list -->
## 今週のテーマ：
#### とりあえずこいつをＡＶＲ-ＵＳＢ経由でコントロールしたいなぁ
てか、拾ってきたモニタでは動いたんだが、ボーレートが20/16になっていて不便だった（水晶のクロック比だけボーレートが速いので困っている）
- で、モニタを修正しようとしたら、ソースが微妙に欠落していて、変更できない。
- ＲＥＮＥＳＡＳのＡＳＭ記述モニタはＣじゃないので嫌。
- 苫小牧のやつもＣじゃないのと、３６９４版がない。改造すりゃあいいんだがＡＳＭは嫌。

<!-- dummy comment line for breaking list -->

しかたないので、自分で書くか・・・あーめんど。

- - - -
## まずはh8300-hmsなgccを入れるところから
ソースは、ここか？
- [http://h8300-hms.sourceforge.net/](http://h8300-hms.sourceforge.net/) 
- [http://sourceforge.net/project/showfiles.php?group_id=24580](http://sourceforge.net/project/showfiles.php?group_id=24580) 

<!-- dummy comment line for breaking list -->

MinGW版とLinux版を入れてみた。
- ちなみにＨ８の~~秋~~アキーテクチャーだが
- ＭＣ６８０００をパクッたようなマイコン。
    - ニモニックがそんな感じ mov.l とか mov.wとか、代入方向も元ローラ方式(左から右に受け流す)。
    - 命令コードのマッピングは全然違うけれど１６ビット長の倍数であるとか。
    - **ビッグエンディアン**(ワード並びが、大きな桁のデジットが先に並ぶ。インテルと逆)であるところ。
- ３２ビットアドレス空間。
    - おっとぉぉ、但しＰＣは２４ビット。
- レジスタは３２ビット×８本。
    - だけど、
    - １６ビットなら１６本。（ＥＲ０〜ＥＲ７を分割）
    - ８ビットは１６本。（Ｒ０〜Ｒ７を分割）
    
    		+--------------+------+------+
    		|      E0      | R0H  | R0L  |  = ER0
    		+--------------+------+------+
    		|      E1      | R1H  | R1L  |  = ER1
    		+--------------+------+------+
    		|      E2      | R2H  | R2L  |  = ER2
    		+--------------+------+------+
    		|      E3      | R3H  | R3L  |  = ER3
    		+--------------+------+------+
    		|      E4      | R4H  | R4L  |  = ER4
    		+--------------+------+------+
    		|      E5      | R5H  | R5L  |  = ER5
    		+--------------+------+------+
    		|      E6      | R6H  | R6L  |  = ER6
    		+--------------+------+------+
    		|      E7      | R7H  | R7L  |  = ER7
    		+--------------+------+------+
    		        |         pc         |
    		        +--------------------+
    		               | EXR  | CCR  |
    		               +------+------+
    - *メモリー空間モード [#z8f33b2b]
    - |ノーマルモード|６４ｋＢ|
    - |アドバンストモード|１６ＭＢ|
- H8/3694F (H8 tiny) は常に６４ｋＢ空間で動くらしい。
- アドバンストモード(32bit空間)というかh8/300H用のコードを落とすときは -mh オプション。
- Ｈ８Ｓのコードを落とすときは -msオプションが必要。
- H8/3694Fは６４ｋモードなので、オプションを -mh -mn と入れる。さらに int のサイズを32bitにするときは -mint32 も入れる。

<!-- dummy comment line for breaking list -->

## アドレッシングモードの癖
|No. |アドレッシングモード| 記号|
|1 |レジスタ直接 |Rn|
|2 |レジスタ間接 |＠ERn|
|3 |ディスプレースメント付きレジスタ間接 |＠(d:16,ERn)/＠(d:24,ERn)|
|4 |ポストインクリメントレジスタ間接|＠ERn+|
|  |プリデクリメントレジスタ間接|＠-ERn|
|5 |絶対アドレス |＠aa:8/＠aa:16/＠aa:24|
|6 |イミディエイト| #xx:8/#xx:16/#xx:32|
|7 |プログラムカウンタ相対 |＠(d:8,PC)/＠(d:16,PC)|
|8 |メモリ間接 |＠＠aa:8|

- ８ビット絶対アドレス（@aa:8）は、上位ビットすべてが1に拡張される(0xffffXX)
- １６ビット絶対アドレス（@aa:16）は、上位８ビットは符号拡張扱い(0〜0x7fff,0xff8000〜0xffffff)
- メモリ間接 (＠＠aa:8)は jmp,jsrでしか使えない。
    - アドレスaa:8は0〜255の番地を指すことしか出来ない。（つまり、例外ベクター内のテーブルジャンプとなる）
    - ノーマルモードでは @aa:8 の指す番地の２バイトを飛び先とする。
    - アドバンストモードでは@aa:8 の指す番地の４バイトのうち下位２４ビットを飛び先とする。

<!-- dummy comment line for breaking list -->



## 速いのか？
- H8/3048とかでは外部バス（１６ビット／８ビット幅は選択できる）にコードやデータが置ける
    - かわりに、しこたまアクセスウェイトが掛かる。
- 内蔵のＦＬＡＳＨ　ＲＯＭにコードを置く限りは、最短で１命令当たり２クロックで実行する。
    - ということは同一クロックならば、ＭＣ６８０００の倍程度の速度。
    - 最短で１命令当たり２クロックというのは、裏を返せば、内蔵ＦＬＡＳＨＲＯＭの１６ビットフェッチサイクルが２クロックということだ。
    - ２０ＭＨｚで動かせば、６８０００の４０ＭＨｚ相当だ。
    - だが、典型的なld命令である、以下のケースでは
    
    		mov.l @(d:16,ERsrc),ERdst ... ワード長３＋データアクセス２＝５回
    - ５回のバスフェッチが入るので１０クロックだ。
    - これを長いと見るか短いと見るか。
    - 普通のＲＩＳＣなら１クロックだ。（キャッシュにＨＩＴする場合のみの話）

<!-- dummy comment line for breaking list -->

~
- Ｈ８Ｓでは、最短で１命令１クロックの実行が出来るようになったらしい。
    - つまりＨ８の半分になる。

<!-- dummy comment line for breaking list -->

## 方針
- 普通にメモリーダンプとポート書き換えとＳレコードの読み込みと、自作プログラムのＲＡＭ上実行が出来ればいいだけなんだけど。

<!-- dummy comment line for breaking list -->

- ＲＯＭは３２ｋＢしかないので、まあ４Ｋ以下で書きたい。
    - じゃあ、余った２８ｋＢに何を置くかと言われても困る。

<!-- dummy comment line for breaking list -->

## 今後の目標
**いったいあんたはＨ８ｔｉｎｙで何をしたいのか**
- ＡＶＲの補完
    - 内蔵ＲＡＭがちょっとだけ多いとかＡ/Ｄとかピン数が多いとか。
    - だけどＵＳＢ接続出来ないのでＡＶＲ-ＵＳＢ経由で繋げばいいんじゃあ。
- 結局のところＡ/Ｄ使って簡単なデジタルテスターもどき。
- もうちょいピン数の多いやつ（３０４８）を使った場合は、ＲＯＭライタとか。
    - ＡＶＲのｍｅｇａ６４４とか使えば出来るんだけどね。Ｈ８じゃなくても。

<!-- dummy comment line for breaking list -->


- - - -
続き
[Ｈ８／ｔｉｎｙｍｏｎ](Ｈ８／ｔｉｎｙｍｏｎ.md) 

